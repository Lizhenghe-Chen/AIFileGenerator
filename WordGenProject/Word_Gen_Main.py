"""
Wordæ–‡æ¡£ç”Ÿæˆå™¨ä¸»å‡½æ•°
åŸºäºOpenAI APIå’Œdocxtplæ¨¡æ¿ç”ŸæˆWordæ–‡æ¡£
"""

from Word_Gen_functions import generate_wordDoc_from_user_input
from typing import Optional


def generate_word_document(
    learning_content: str,
    user_requirements: Optional[str] = None,
    custom_filename: Optional[str] = None,
) -> str:
    """
    æ ¹æ®ç”¨æˆ·è¾“å…¥ç”ŸæˆWordæ–‡æ¡£çš„ä¸»å‡½æ•°

    Args:
        learning_content (str): ç”¨æˆ·è¾“å…¥çš„å†…å®¹æç¤º
        custom_filename (str, optional): è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆä¸åŒ…å«æ‰©å±•åï¼‰

    Returns:
        str: ç”Ÿæˆçš„æ–‡æ¡£æ–‡ä»¶è·¯å¾„

    Raises:
        Exception: å½“ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸
    """
    try:
        filename = generate_wordDoc_from_user_input(
            learning_content, user_requirements, custom_filename
        )
        print(f"\nğŸ‰ æˆåŠŸç”ŸæˆWordæ–‡æ¡£: {filename}")
        return filename
    except Exception as e:
        print(f"âŒ ç”ŸæˆWordæ–‡æ¡£æ—¶å‡ºé”™: {e}")
        raise e


def main():
    """ä¸»å‡½æ•° - ç¤ºä¾‹ç”¨æ³•"""

    # ç¤ºä¾‹ç”¨æˆ·è¾“å…¥
    learning_content = """
ä¸“ä¸šæ•™å­¦èµ„æ–™  
ä¸»é¢˜ï¼šPID æ§åˆ¶çš„â€œæŠ—é¥±å’Œï¼ˆAnti-Windupï¼‰æœºåˆ¶â€â€”â€”åŸç†ã€æ•°å­¦å»ºæ¨¡ä¸å·¥ç¨‹å®ç°

1. é—®é¢˜èƒŒæ™¯  
åœ¨è¿ç»­è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ‰§è¡Œå™¨è¾¾åˆ°å…¶ç‰©ç†æé™ï¼ˆå¦‚é˜€é—¨å…¨å¼€ã€ç”µæœºç”µå‹é¥±å’Œï¼‰ï¼Œè¯¯å·® e(t)=r(t)âˆ’y(t) ä»æŒç»­å­˜åœ¨ï¼Œç§¯åˆ†å™¨ä¼šä¸æ–­ç´¯ç§¯è¯¯å·® â†’ ç§¯åˆ†é¡¹ I(t) è¿…é€Ÿå¢å¤§ â†’ ç³»ç»Ÿå‡ºç°ä¸¥é‡çš„è¶…è°ƒä¸æŒ¯è¡ï¼Œè¯¥ç°è±¡ç§°ä¸ºç§¯åˆ†é¥±å’Œï¼ˆIntegral Wind-upï¼‰ã€‚

2. æ•°å­¦æ¨¡å‹ï¼ˆæ ‡å‡† PIDï¼‰  
u(t)=K_p e(t)+K_iâˆ«_0^t e(Ï„)dÏ„+K_d de(t)/dt  
å½“ |u(t)|>u_max æ—¶ï¼Œå®é™…è¾“å‡º u_a(t)=sat(u(t))=sign(u(t))Â·u_maxï¼Œå¯¼è‡´ u(t)â‰ u_a(t)ã€‚

3. æŠ—é¥±å’Œç›®æ ‡  
â€¢ åœ¨é¥±å’Œé˜¶æ®µæŠ‘åˆ¶ç§¯åˆ†é¡¹ç»§ç»­å¢é•¿ï¼›  
â€¢ åœ¨é€€å‡ºé¥±å’Œåï¼Œç³»ç»Ÿåº”å¿«é€Ÿã€å¹³æ»‘åœ°å›åˆ°çº¿æ€§å·¥ä½œåŒºã€‚

4. ç»å…¸æŠ—é¥±å’Œç­–ç•¥ï¼šBack-Calculationï¼ˆåé¦ˆè¡¥å¿æ³•ï¼‰  
åœ¨æ ‡å‡† PID ä¹‹åæ’å…¥â€œæŠ—é¥±å’Œåé¦ˆå›è·¯â€ï¼Œæ•°å­¦æè¿°ï¼š  
e_i(t)=e(t)+K_aw(u_a(t)âˆ’u(t))  
ç§¯åˆ†å™¨æ”¹ä¸ºï¼š  
dI/dt = K_i e_i(t)  
å…¶ä¸­ K_aw ä¸ºæŠ—é¥±å’Œå¢ç›Šï¼ˆ1/T_tï¼ŒT_t ç§°ä¸ºè·Ÿè¸ªæ—¶é—´å¸¸æ•°ï¼‰ã€‚  
â€¢ å½“æœªé¥±å’Œï¼šu=u_a â‡’ e_i=e â‡’ æ­£å¸¸ç§¯åˆ†ï¼›  
â€¢ å½“é¥±å’Œï¼šu_aâ‰ u â‡’ e_iâ‰ eï¼Œå¼•å…¥è´Ÿåé¦ˆ e_i=eâˆ’K_awÎ”uï¼ŒÎ”u=u_aâˆ’uï¼Œç§¯åˆ†å™¨è¢«â€œæ‹‰å›â€ã€‚

5. ç¨³å®šæ€§åˆ†æ  
çº¿æ€§åŒ–å‡è®¾ï¼š  
G_aw(s)=K_aw/(s+K_aw)  
å¯è¯æ˜ï¼šåªè¦ K_aw>0ï¼ŒæŠ—é¥±å’Œå›è·¯è‡ªèº«ç¨³å®šï¼›é—­ç¯ç¨³å®šæ€§ç”±çº¿æ€§ PID è®¾è®¡ä¸ K_aw å…±åŒå†³å®šã€‚  
æ¨èæ•´å®šï¼šT_tâ‰ˆâˆš(T_i T_d)ï¼ˆÃ…strÃ¶m-HÃ¤gglund è§„åˆ™ï¼‰ï¼Œå…¶ä¸­ T_i=K_p/K_iï¼ŒT_d=K_d/K_pã€‚

6. ç¦»æ•£å®ç°ï¼ˆä½ç½®å¼ç®—æ³•ï¼‰  
ä¼ªä»£ç ï¼ˆC è¯­æ³•ï¼‰ï¼š
```c
float PID_AntiWindup(float r, float y, float u_max)
{
    static float I = 0.0f, y_prev = 0.0f;
    float e  = r - y;
    float P  = Kp * e;
    float D  = Kd * (y_prev - y) / Ts;   // å¾®åˆ†é¡¹ç”¨æµ‹é‡å€¼å·®åˆ†é¿å…å¾®åˆ†å†²å‡»
    float u0 = P + I + D;
    float ua = fmaxf(-u_max, fminf(u0, u_max));
    float ei = e + Kaw * (ua - u0);
    I += Ki * ei * Ts;
    y_prev = y;
    return ua;
}
```

7. å·¥ç¨‹è¡¥å……  
â€¢ å¯¹å¤šå˜é‡ç³»ç»Ÿï¼Œå¯å°†æŠ—é¥±å’Œæ‰©å±•ä¸ºâ€œæ–¹å‘ä¿æŒâ€ç®—æ³•ï¼ˆDirectional Anti-Windupï¼‰ã€‚  
â€¢ å®é™…è°ƒè¯•æ—¶ï¼Œå¯é€šè¿‡é˜¶è·ƒæµ‹è¯•è§‚æµ‹ï¼šé¥±å’Œé˜¶æ®µ I åˆ†é‡åº”è¢«é™åˆ¶ï¼›é€€å‡ºé¥±å’Œåè°ƒèŠ‚æ—¶é—´åº”ç¼©çŸ­ã€‚  
â€¢ å¯¹ä¼ºæœç”µæœºï¼Œå¯ç»“åˆç”µæµç¯é™å¹…ã€é€Ÿåº¦å‰é¦ˆï¼Œå®ç°çº§è”æŠ—é¥±å’Œã€‚

8. å°ç»“  
æŠ—é¥±å’Œä¸æ˜¯é¢å¤–â€œè¡¥ä¸â€ï¼Œè€Œæ˜¯ PID æ§åˆ¶å™¨åœ¨å·¥ç¨‹å¯å®æ–½æ€§ä¸Šçš„å¿…è¦ç»„æˆéƒ¨åˆ†ï¼›å…¶è®¾è®¡åº”éµå¾ªï¼š  
(1) å»ºç«‹é¥±å’Œéçº¿æ€§æ¨¡å‹ï¼›  
(2) é€‰æ‹©åŒ¹é…çš„æŠ—é¥±å’Œç»“æ„ï¼ˆBack-Calculationã€Clampingã€Observer-based ç­‰ï¼‰ï¼›  
(3) é€šè¿‡çº¿æ€§åŒ–æˆ–å°å¢ç›Šå®šç†éªŒè¯ç¨³å®šæ€§ï¼›  
(4) åœ¨å®é™…ç¡¬ä»¶ä¸Šé—­ç¯éªŒè¯åŠ¨æ€æ€§èƒ½ä¸é²æ£’æ€§ã€‚

ï¼ˆå®Œï¼‰
    """
    user_requirements = (
        "é€‰æ‹©é¢˜å¿…é¡»å…¨éƒ¨ä¸ºå•é€‰é¢˜ï¼å¹¶ç»™å‡ºè‡³å°‘5é“é¢˜ç›®ã€‚ç®€ç­”é¢˜è‡³å°‘4é“ã€‚éœ€è¦æœ‰å…¬å¼è€ƒæ ¸ã€‚"
    )
    custom_filename = "Test"  # å¯é€‰çš„è‡ªå®šä¹‰æ–‡ä»¶å
    # ç”ŸæˆWordæ–‡æ¡£
    try:
        result_path = generate_word_document(
            learning_content, user_requirements, custom_filename
        )
        print(f"âœ… æ–‡æ¡£å·²ä¿å­˜è‡³: {result_path}")
    except Exception as e:
        print(f"âš ï¸ ç”Ÿæˆå¤±è´¥: {e}")


if __name__ == "__main__":
    main()
